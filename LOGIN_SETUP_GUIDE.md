# 登录系统配置指南

## 🔍 问题分析

你遇到的登录问题（使用 `admin/123456` 无法登录）是由于**环境变量未正确配置**导致的。

### 根本原因
- **`JWT_TOKEN` 已设置** ✅ 这是好的
- **但 `ADMIN_PASSWORD` 未设置** ❌ 这是导致登录失败的关键原因

根据登录系统的逻辑，当 `ADMIN_PASSWORD` 未设置时，超级管理员登录会失败，然后系统会尝试其他登录方式，但如果没有其他用户，最终都会失败。

## 🛠️ 解决方案

我已经更新了部署脚本，现在需要你按照以下步骤配置环境变量：

### 步骤1：在GitHub仓库中设置Secrets

1. 进入你的GitHub仓库页面
2. 点击 **Settings** 选项卡
3. 在左侧菜单中找到 **Secrets and variables** → **Actions**
4. 点击 **New repository secret** 按钮，添加以下secrets：

#### 必需的环境变量：
```
名称: ADMIN_PASSWORD
值: 你的超级管理员密码（例如：123456）
```

```
名称: JWT_TOKEN
值: 你的JWT密钥（已设置）
```

```
名称: MAIL_DOMAIN
值: 你的邮箱域名（例如：example.com）
```

#### 可选的环境变量：
```
名称: ADMIN_NAME
值: admin（默认值，可不设置）
```

### 步骤2：重新触发部署

1. 提交代码更改到GitHub
2. 或者手动触发GitHub Actions：
   - 进入GitHub仓库的 **Actions** 选项卡
   - 选择 **Deploy to Cloudflare Workers** 工作流
   - 点击 **Run workflow** 按钮

### 步骤3：测试登录

部署完成后，使用以下凭据登录：
- **用户名**: `admin`
- **密码**: 你在 `ADMIN_PASSWORD` 中设置的密码

## 📋 登录系统验证流程

系统按照以下优先级进行认证：

### 1. 超级管理员认证（最高优先级）
- **用户名**: 必须与 `ADMIN_NAME` 环境变量匹配（默认 `admin`）
- **密码**: 必须与 `ADMIN_PASSWORD` 环境变量精确匹配

### 2. 访客认证
- **用户名**: `guest`
- **密码**: 必须与 `GUEST_PASSWORD` 环境变量匹配

### 3. 普通用户认证
- **用户名**: 在数据库 `users` 表中查找
- **密码**: 使用密码哈希验证

### 4. 邮箱登录
- **用户名**: 有效的邮箱地址
- **密码**: 邮箱地址本身

## 🔧 技术细节

我已经更新了以下文件来支持环境变量配置：

### 1. GitHub Actions工作流文件
- 添加了环境变量传递：`ADMIN_PASSWORD`, `JWT_TOKEN`, `MAIL_DOMAIN`

### 2. 部署脚本
- `deploy-github-actions.js` - 添加了环境变量设置逻辑
- `deploy-github-actions-improved.js` - 添加了环境变量设置逻辑

### 部署脚本现在会自动：
1. 检查并创建D1数据库
2. 初始化数据库表结构
3. 设置必要的环境变量（如果提供了）
4. 部署到Cloudflare Workers

## ⚠️ 注意事项

1. **密码安全**: 确保 `ADMIN_PASSWORD` 使用强密码
2. **JWT安全**: `JWT_TOKEN` 应该是随机生成的强密钥
3. **域名配置**: `MAIL_DOMAIN` 应该是你拥有的有效域名
4. **测试登录**: 部署完成后立即测试登录功能

## 🔄 故障排除

如果仍然无法登录，请检查：

1. **GitHub Actions日志**: 查看部署过程中是否有错误
2. **环境变量设置**: 确认所有secrets都已正确设置
3. **密码匹配**: 确保登录时使用的密码与 `ADMIN_PASSWORD` 完全一致
4. **用户名大小写**: 系统会自动将用户名转换为小写，使用 `admin`（小写）

## 📞 获取帮助

如果按照上述步骤操作后仍然无法登录，请提供：
1. GitHub Actions部署日志
2. 登录时返回的具体错误信息
3. 你的环境变量配置情况

这样我可以提供更具体的帮助。