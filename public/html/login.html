<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>登录 - Temp Email</title>
    <style>.precheck-hide body{ visibility: hidden; }</style>
    <script>
      // 立即检查登录状态（在任何其他脚本之前）
      (function(){
        try{
          var hasToken = document.cookie.split(';').some(function(c){ 
            return c.trim().indexOf('iding-session=') === 0; 
          });
          
          // 如果有cookie但是从其他页面跳转过来的，先验证有效性再跳转
          // 避免无效cookie导致的循环跳转和页面闪现
          if (hasToken && document.referrer) {
            // 异步验证，不阻止页面渲染
            (async function(){
              try{
                const controller = new AbortController();
                const tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 1500);
                const r = await fetch('/api/session', { 
                  method: 'GET', 
                  headers: { 'Cache-Control': 'no-cache' },
                  credentials: 'include',
                  signal: controller.signal
                });
                clearTimeout(tid);
                if (r && r.ok){
                  location.replace('/');
                } else {
                  // cookie无效，清除它
                  document.cookie = 'iding-session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                }
              }catch(_){ 
                // 验证失败，保持在登录页面
              }
            })();
            return;
          } else if (hasToken && !document.referrer) {
            // 直接访问登录页且有cookie，立即重定向
            location.replace('/');
            return;
          }
          
          // 没有cookie，做一次网络检查（可能cookie刚设置还没生效）
          fetch('/api/session', { 
            method: 'GET', 
            headers: { 'Cache-Control': 'no-cache' },
            credentials: 'include'
          }).then(function(r){
            if (r && r.ok){
              location.replace('/');
            }
          }).catch(function(){ 
            // 会话检查失败，保持在登录页面
          });
        }catch(_){ 
          // 错误处理，保持在登录页面
        }
      })();
    </script>
    <script src="/js/auth-guard.js"></script>
    <script>
      // 已登录访问登录页时直接回首页；登出场景跳过检查
      (function(){
        try{ document.documentElement.classList.add('precheck-hide'); }catch(_){ }
        try{
          var u = new URL(location.href);
          var fromLogout = (u.searchParams.get('from') === 'logout') || (sessionStorage.getItem('mf:just_logged_out') === '1');
          if (fromLogout){
            sessionStorage.removeItem('mf:just_logged_out');
            document.documentElement.classList.remove('precheck-hide');
            return;
          }
        }catch(_){ }
        // Cookie检查已在页面顶部执行，这里跳过重复检查
        // 2) 网络兜底，延长超时时间减少误判
        try{
          var controller = new AbortController();
          var tid = setTimeout(function(){ try{ controller.abort(); }catch(_){ } }, 1500); // 从500ms延长到1500ms
          fetch('/api/session', { 
            headers: { 'Cache-Control': 'no-cache' }, 
            signal: controller.signal,
            credentials: 'include'
          })
            .then(function(r){
              clearTimeout(tid);
              if (r && r.ok){ location.replace('/'); return; }
              document.documentElement.classList.remove('precheck-hide');
            })
            .catch(function(){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } });
        }catch(_){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } }
        // 最长 2s 兜底显示（从1s延长到2s）
        setTimeout(function(){ try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ } }, 2000);
      })();
    </script>
    
    <script src="/js/mock.js"></script>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="shortcut icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="stylesheet" href="/css/login.css" />
  </head>
  <body>
    <div class="bg"></div>
    <div class="center">
      <div class="card">
        <div class="logo"></div>
        <h1 class="login-title">
          <span class="login-title-text">登录到 Temp Email</span>
          <a
            class="login-doc-link"
            href="https://github.com/noxenys/temp-mail/blob/main/DEPLOYMENT_GUIDE.md"
            target="_blank"
            rel="noreferrer"
          >
            部署文档
          </a>
        </h1>

        <div id="info-banner" class="info-banner" hidden>
          <div class="info-banner-icon" aria-hidden="true">i</div>
          <div class="info-banner-main">
            <div id="info-banner-title" class="info-banner-title"></div>
            <div id="info-banner-desc" class="info-banner-desc"></div>
          </div>
          <a
            id="info-banner-link"
            class="info-banner-link"
            href="https://github.com/noxenys/temp-mail/blob/main/DEPLOYMENT_GUIDE.md"
            target="_blank"
            rel="noreferrer"
          >
            查看文档
          </a>
        </div>

        <div id="err" class="err"></div>
        <input id="username" class="input" type="text" placeholder="用户名/邮箱" />
        <input id="pwd" class="input" type="password" placeholder="密码" />
        <button id="login" class="btn">登录</button>
        <div id="guest-login-section">
          <button id="guest-login" class="btn-secondary" type="button">使用访客账号登录</button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <script src="/js/toast-utils.js"></script>
    <script src="/env.js"></script>
    <script src="/js/login.js"></script>
  </body>
  </html>
