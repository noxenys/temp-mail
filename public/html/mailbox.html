<!DOCTYPE html>
<html lang="zh-CN" class="precheck-hide">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„é‚®ç®± - iDing'sä¸´æ—¶é‚®ç®±</title>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>.precheck-hide body{ visibility: hidden !important; }</style>
  <style>
    /* ä¸‰æ€å®¹å™¨æ ·å¼ */
    .state-empty, .state-error, .state-loading {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 2rem;
      text-align: center;
      color: #64748b;
    }
    
    .state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .state-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #1e293b;
    }
    
    .state-description {
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    
    .state-button {
      padding: 0.5rem 1.5rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
    }
  </style>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="shortcut icon" href="/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/css/app.css" />
  <link rel="stylesheet" href="/css/mailbox.css" />
  <script src="/js/auth-guard.js" defer></script>
  <script>
    // è®¿é—®é‚®ç®±é¡µå…ˆåšå‰ç«¯å¿«é€Ÿé‰´æƒï¼Œä»…å…è®¸ mailbox è§’è‰²
    (function(){
      fetch('/api/session', { headers: { 'Cache-Control': 'no-cache' } })
        .then(r => r.ok ? r.json() : Promise.reject('unauth'))
        .then(s => {
          if (s && s.role === 'mailbox'){
            try{ document.documentElement.classList.remove('precheck-hide'); }catch(_){ }
            
            // çŠ¶æ€ç®¡ç†é€»è¾‘
            const stateLoading = document.getElementById('state-loading');
            const stateEmpty = document.getElementById('state-empty');
            const stateError = document.getElementById('state-error');
            const emailList = document.getElementById('email-list');
            const listPager = document.getElementById('list-pager');
            
            // çŠ¶æ€åˆ‡æ¢å‡½æ•°
            function showState(state) {
              [stateLoading, stateEmpty, stateError, emailList, listPager].forEach(el => {
                if (el) el.style.display = 'none';
              });
              
              if (state === 'loading' && stateLoading) {
                stateLoading.style.display = 'flex';
              } else if (state === 'empty' && stateEmpty) {
                stateEmpty.style.display = 'flex';
              } else if (state === 'error' && stateError) {
                stateError.style.display = 'flex';
              } else if (state === 'list' && emailList) {
                emailList.style.display = 'block';
                if (listPager) listPager.style.display = 'flex';
              }
            }
            
            // æŒ‰é’®äº‹ä»¶ç»‘å®š
            document.getElementById('refresh-empty')?.addEventListener('click', () => {
              loadEmails();
            });
            
            document.getElementById('retry-error')?.addEventListener('click', () => {
              loadEmails();
            });
            
            // é‚®ä»¶åŠ è½½å‡½æ•°
            function loadEmails() {
              showState('loading');
              
              fetch('/api/emails', { 
                headers: { 'Cache-Control': 'no-cache' } 
              })
                .then(r => {
                  if (!r.ok) throw new Error('Network response was not ok');
                  return r.json();
                })
                .then(data => {
                  if (data && data.emails && data.emails.length > 0) {
                    showState('list');
                    // è¿™é‡Œåº”è¯¥è°ƒç”¨ç°æœ‰çš„æ¸²æŸ“é€»è¾‘
                    if (window.renderEmailList) {
                      window.renderEmailList(data.emails);
                    }
                  } else {
                    showState('empty');
                  }
                })
                .catch(error => {
                  console.error('Failed to load emails:', error);
                  showState('error');
                });
            }
            
            // åˆå§‹åŠ è½½
            loadEmails();
            
            return;
          }
          // å…¶ä»–è§’è‰²ï¼šå›é¦–é¡µ
          location.replace('/');
        })
        .catch(() => {
          // æœªç™»å½•ï¼šè¿›å…¥åŠ è½½é¡µåšé‰´æƒ
          if (window.AuthGuard) { window.AuthGuard.goLoading('/html/mailbox.html', 'æ­£åœ¨æ ¡éªŒæƒé™â€¦'); }
          else { location.replace('/templates/loading.html?redirect=%2Fhtml%2Fmailbox.html&status=' + encodeURIComponent('æ­£åœ¨æ ¡éªŒæƒé™â€¦')); }
        });
    })();
  </script>
</head>
<body>
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <span class="brand-icon">ğŸ“§</span>
      <span class="brand-text">iDing'sä¸´æ—¶é‚®ç®±</span>
    </div>
    <div id="role-badge" class="role-badge" title="é‚®ç®±ç”¨æˆ·">é‚®ç®±ç”¨æˆ·</div>
    <div class="nav-actions">
      <a id="repo" class="btn btn-ghost" href="https://github.com/idinging/freemail" target="_blank" rel="noopener noreferrer" title="GitHub å¼€æºä»“åº“">
        <span class="btn-icon">ğŸ”—</span>
        <span class="btn-text">GitHub</span>
      </a>
      <button id="logout" class="btn btn-secondary" title="é€€å‡ºç™»å½•">
        <span class="btn-icon">ğŸšª</span>
        <span class="btn-text">é€€å‡ºç™»å½•</span>
      </button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<div class="container mailbox-container">
  <div class="main mailbox-main">
    <!-- é‚®ç®±ä¿¡æ¯å¡ç‰‡ -->
    <div class="card mailbox-info-card">
      <h2>
        <span class="card-icon">ğŸ“¬</span>
        æˆ‘çš„é‚®ç®±
      </h2>
      <div class="mailbox-info">
        <div class="mailbox-display">
          <span class="mailbox-icon">ğŸ“§</span>
          <span id="current-mailbox" class="mailbox-address">åŠ è½½ä¸­...</span>
          <button id="copy-mailbox" class="btn btn-secondary btn-sm" title="å¤åˆ¶é‚®ç®±åœ°å€">
            <span class="btn-icon">ğŸ“‹</span>
            <span>å¤åˆ¶</span>
          </button>
        <!-- ä¿®æ”¹å¯†ç  -->
          <button id="change-password" class="btn btn-ghost btn-sm" title="ä¿®æ”¹å¯†ç ">
            <span class="btn-icon">ğŸ”’</span>
            <span>ä¿®æ”¹å¯†ç </span>
          </button>
        </div>
        <div class="mailbox-toolbar">
          <div class="toolbar-left">
            <span class="chip chip-unread">æœªè¯» <span id="unread-count">0</span></span>
            <span class="chip chip-total">å…¨éƒ¨ <span id="total-count">0</span></span>
          </div>
          <div class="toolbar-right">
            <label class="toggle" title="å¼€å¯åæŒ‰é—´éš”è‡ªåŠ¨åˆ·æ–°">
              <input id="auto-refresh" type="checkbox" />
              <span>è‡ªåŠ¨åˆ·æ–°</span>
            </label>
            <select id="refresh-interval" class="select select-sm" title="åˆ·æ–°é—´éš”">
              <option value="10">10ç§’</option>
              <option value="30" selected>30ç§’</option>
              <option value="60">60ç§’</option>
            </select>
            <input id="search-box" class="input input-sm" placeholder="æœç´¢å‘ä»¶äºº/ä¸»é¢˜" />
            <button id="clear-filter" class="btn btn-ghost btn-sm" title="æ¸…ç©ºç­›é€‰">æ¸…ç©º</button>
            <button id="refresh-emails" class="btn btn-ghost" title="ç«‹å³åˆ·æ–°">
              <span class="btn-icon">ğŸ”„</span>
              <span>åˆ·æ–°</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- æ”¶ä»¶ç®±å¡ç‰‡ -->
    <div class="card inbox-card">
      <div class="listcard-header">
        <h2 class="listcard-title">
          <span class="card-icon">ğŸ“¨</span>
          <span>æ”¶ä»¶ç®±</span>
        </h2>
        <div id="list-loading" class="loading-indicator" style="pointer-events:none" role="status" aria-live="polite">
          <div class="spinner"></div>
          <span>åŠ è½½ä¸­â€¦</span>
        </div>
      </div>
      <div class="list-viewport" style="position:relative;contain:layout paint;isolation:isolate;">
        <div id="email-list" class="list"></div>
        
        <!-- ä¸‰æ€å®¹å™¨ -->
        <div id="state-loading" class="state-loading">
          <div class="state-icon">â³</div>
          <div class="state-title">åŠ è½½ä¸­...</div>
          <div class="state-description">æ­£åœ¨è·å–é‚®ä»¶åˆ—è¡¨ï¼Œè¯·ç¨å€™</div>
        </div>
        
        <div id="state-empty" class="state-empty">
          <div class="state-icon">ğŸ“­</div>
          <div class="state-title">æš‚æ— é‚®ä»¶</div>
          <div class="state-description">ä»…æ˜¾ç¤ºè¿‘24å°æ—¶å†…çš„é‚®ä»¶ï¼Œè¶…è¿‡24å°æ—¶çš„é‚®ä»¶ä¼šè‡ªåŠ¨åˆ é™¤</div>
          <button id="refresh-empty" class="state-button" style="background:#3b82f6;color:white;">åˆ·æ–°</button>
        </div>
        
        <div id="state-error" class="state-error">
          <div class="state-icon">âŒ</div>
          <div class="state-title">åŠ è½½å¤±è´¥</div>
          <div class="state-description">æ— æ³•è·å–é‚®ä»¶åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</div>
          <button id="retry-error" class="state-button" style="background:#ef4444;color:white;">é‡è¯•</button>
        </div>
        
        <div id="list-pager" class="pager" style="display:none">
          <button id="prev-page" class="btn btn-ghost btn-sm">ä¸Šä¸€é¡µ</button>
          <span id="page-info" class="muted" style="min-width:100px;text-align:center"></span>
          <button id="next-page" class="btn btn-ghost btn-sm">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="footer-slot"></div>

<!-- é‚®ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal" id="email-modal">
  <div class="modal-card">
    <div class="modal-header">
      <div id="modal-subject">
        <span class="modal-icon">ğŸ“§</span>
        <span>é‚®ä»¶è¯¦æƒ…</span>
      </div>
      <button id="modal-close" class="close">âœ•</button>
    </div>
    <div class="modal-body">
      <div id="modal-content"></div>
    </div>
  </div>
</div>
  <script src="/js/toast-utils.js"></script>
  <script type="module" src="/js/mailbox.js"></script>
<script>
  // åŠ¨æ€åŠ è½½å…¬å…± footer æ¨¡æ¿
  (async function(){
    try{
      const res = await fetch('/templates/footer.html', { cache: 'no-cache' });
      const html = await res.text();
      const slot = document.getElementById('footer-slot');
      if (slot){
        slot.outerHTML = html;
        setTimeout(()=>{ const y=document.getElementById('footer-year'); if (y) y.textContent=new Date().getFullYear(); },0);
      }
    }catch(_){ }
  })();
</script>
</body>
</html>
<!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
<div class="modal" id="confirm-modal">
  <div class="modal-card confirm-card">
    <div class="modal-header confirm-header">
      <div>
        <span class="modal-icon">âš ï¸</span>
        <span>ç¡®è®¤æ“ä½œ</span>
      </div>
      <button id="confirm-close" class="close">âœ•</button>
    </div>
    <div class="modal-body confirm-body">
      <div id="confirm-message" class="confirm-message"></div>
      <div class="confirm-actions">
        <button id="confirm-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
        <button id="confirm-ok" class="btn btn-danger">ç¡®å®š</button>
      </div>
    </div>
  </div>
</div>

<!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
<div class="modal" id="password-modal">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <span class="modal-icon">ğŸ”’</span>
        <span>ä¿®æ”¹å¯†ç </span>
      </div>
      <button id="password-close" class="close">âœ•</button>
    </div>
    <div class="modal-body">
      <form id="password-form">
        <div class="form-group">
          <label for="current-password">å½“å‰å¯†ç </label>
          <input type="text" id="current-password" class="input" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required />
        </div>
        <div class="form-group">
          <label for="new-password">æ–°å¯†ç </label>
          <input type="text" id="new-password" class="input" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" minlength="6" required />
        </div>
        <div class="form-group">
          <label for="confirm-password">ç¡®è®¤æ–°å¯†ç </label>
          <input type="text" id="confirm-password" class="input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " minlength="6" required />
        </div>
        <div class="form-actions">
          <button type="button" id="password-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
          <button type="submit" id="password-submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
        </div>
      </form>
    </div>
  </div>
</div>