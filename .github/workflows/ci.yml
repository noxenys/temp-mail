name: Deploy to Cloudflare Workers

on:
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      WORKER_URL: ${{ secrets.WORKER_URL }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Wrangler globally
      run: npm install -g wrangler
      
    - name: Deploy to Cloudflare Workers
      run: node deploy-github-actions.js
      env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_TOKEN: ${{ secrets.JWT_TOKEN }}
          MAIL_DOMAIN: ${{ secrets.MAIL_DOMAIN }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          ADMIN_NAME: ${{ secrets.ADMIN_NAME }}
          ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
          ADMIN_PASS: ${{ secrets.ADMIN_PASS }}
          GUEST_PASSWORD: ${{ secrets.GUEST_PASSWORD }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_TOKEN: ${{ secrets.RESEND_TOKEN }}
          RESEND: ${{ secrets.RESEND }}
          FORWARD_RULES: ${{ secrets.FORWARD_RULES }}
          CACHE_TTL: ${{ secrets.CACHE_TTL }}
          SITE_MODE: ${{ secrets.SITE_MODE }}
          GUEST_ENABLED: ${{ secrets.GUEST_ENABLED }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          MAX_EMAIL_SIZE: ${{ secrets.MAX_EMAIL_SIZE }}
          EMAIL_RETENTION_DAYS: ${{ secrets.EMAIL_RETENTION_DAYS }}

    - name: Set and check Telegram Webhook
      if: ${{ env.TELEGRAM_BOT_TOKEN != '' && env.WORKER_URL != '' }}
      run: |
        WORKER_BASE="${WORKER_URL%/}"
        WEBHOOK_URL="${WORKER_BASE}/telegram/webhook"
        echo "设置 Telegram Webhook 到: ${WEBHOOK_URL}"
        SET_RESP=$(curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/setWebhook" --get --data-urlencode "url=${WEBHOOK_URL}" || echo "")
        echo "setWebhook 响应: ${SET_RESP}"
        INFO_RESP=$(curl -sS "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getWebhookInfo" || echo "")
        echo "getWebhookInfo 响应: ${INFO_RESP}"
        if echo "${INFO_RESP}" | grep -q '"url"'; then
          if echo "${INFO_RESP}" | grep -q '"last_error_date"'; then
            echo "::warning title=Telegram Webhook 状态::最近存在错误，请检查 Worker 日志和域名配置"
          else
            echo "Telegram Webhook 看起来已正常配置"
          fi
        else
          echo "::warning title=Telegram Webhook 状态::未检测到有效 Webhook URL，请检查 TELEGRAM_BOT_TOKEN 和 WORKER_URL"
        fi
